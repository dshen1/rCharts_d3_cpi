<!doctype HTML>
<meta charset = 'utf-8'>
<html>
  <head>
    <link rel='stylesheet' href='http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css'>
    <link rel='stylesheet' href='http://timelyportfolio.github.io/rCharts_d3_cpi/css/local.css'>
    
    <script src='http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.min.js' type='text/javascript'></script>
    <script src='http://d3js.org/d3.v3.js' type='text/javascript'></script>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.js' type='text/javascript'></script>
    
    <style>
    .rChart {
      display: block;
      margin-left: auto; 
      margin-right: auto;
      width: 800px;
      height: 400px;
    }  
    </style>
    
  </head>
  <body ng-app>
    
    <div></div>    
    <div class='container' ng-controller="DemoCtrl">
  <div class='row'>
    <div class='col-md-3'>
      <form class='well'>

        <select
          ng-model="selected" 
          ng-options="c.item_code for c in filters" 
          class="form-control" multiple size="10">
        </select>

      </form>
    </div>
    <div class='col-md-8'>
      <div class="bs-docs-example">
        <div id='chart280847ef32fe' class='rChart'>
          <svg></svg>
        </div>
        
      </div>
    </div>
  </div>
</div>




<script>
function DemoCtrl( $scope ){
  $scope.opts = {
 "dom": "chart280847ef32fe",
"width":    800,
"height":    400,
"bodyattrs": "ng-app",
"filters": {
 "code": [ "701111", "701311", "701312", "701321", "701322", "702111", "702112", "702211", "702212", "702213", "702221", "702411", "702421", "702611", "703111", "703112", "703113", "703211", "703212", "703213", "703311", "703312", "703411", "703421", "703422", "703423", "703425", "703431", "703432", "703511", "703512", "703611", "703612", "703613", "704111", "704211", "704212", "704311", "704312", "704313", "704314", "704321", "704411", "704412", "704413", "704421", "705111", "705121", "705141", "705142", "706111", "706211", "706212", "706311", "707111", "708111", "708112", "709111", "709112", "709211", "709212", "709213", "710111", "710122", "710211", "710212", "710411", "711111", "711211", "711311", "711312", "711411", "711412", "711413", "711414", "711415", "711416", "711417", "711418", "712111", "712112", "712211", "712311", "712401", "712402", "712403", "712404", "712405", "712406", "712407", "712408", "712409", "712410", "712411", "712412", "713111", "713311", "713312", "714111", "714221", "714231", "714232", "714233", "715111", "715211", "715212", "715311", "716111", "716113", "716114", "716116", "716121", "716141", "717111", "717112", "717113", "717114", "717311", "717312", "717324", "717325", "717326", "717327", "717411", "717412", "717413", "718311", "718631", "720111", "720211", "720221", "720222", "720311", "72511", "72601", "72610", "72611", "72620", "72621", "74712", "74713", "74714", "74715", "74716", "74717", "7471A", "FC1101", "FC2101", "FC3101", "FC4101", "FD2101", "FD3101", "FD4101", "FF1101", "FL2101" ],
"item_code": [ "Flour, white, all purpose, per lb. (453.6 gm)", "Rice, white, long grain, precooked (cost per pound/453.6 grams)", "Rice, white, long grain, uncooked, per lb. (453.6 gm)", "Spaghetti (cost per pound/453.6 grams)", "Spaghetti and macaroni, per lb. (453.6 gm)", "Bread, white, pan, per lb. (453.6 gm)", "Bread, French, per lb. (453.6 gm)", "Bread, rye, pan (cost per pound/453.6 grams)", "Bread, whole wheat, pan, per lb. (453.6 gm)", "Bread, wheat blend, pan (cost per pound/453.6 grams)", "Rolls, hamburger (cost per pound/453.6 grams)", "Cupcakes, chocolate (cost per pound/453.6 grams)", "Cookies, chocolate chip, per lb. (453.6 gm)", "Crackers, soda, salted, per lb. (453.6 gm)", "Ground chuck, 100% beef, per lb. (453.6 gm)", "Ground beef, 100% beef, per lb. (453.6 gm)", "Ground beef, lean and extra lean, per lb. (453.6 gm)", "Chuck roast, USDA Choice, bone-in, per lb. (453.6 gm)", "Chuck roast, graded and ungraded, excluding USDA Prime and Choice, per lb. (453.6 gm)", "Chuck roast, USDA Choice, boneless, per lb. (453.6 gm)", "Round roast, USDA Choice, boneless, per lb. (453.6 gm)", "Round roast, graded and ungraded, excluding USDA Prime and Choice, per lb. (453.6 gm)", "Rib roast, USDA Choice, bone-in, per lb. (453.6 gm)", "Steak, chuck, U.S. choice, bone-in (cost per pound/453.6 grams)", "Steak, T-Bone, USDA Choice, bone-in, per lb. (453.6 gm)", "Steak, porterhouse, U.S. choice, bone-in (cost per pound/453.6 grams)", "Steak, rib eye, USDA Choice, boneless, per lb. (453.6 gm)", "Short ribs, any primal source, bone-in, per lb. (453.6 gm)", "Beef for stew, boneless, per lb. (453.6 gm)", "Steak, round, USDA Choice, boneless, per lb. (453.6 gm)", "Steak, round, graded and ungraded, excluding USDA Prime and Choice, per lb. (453.6 gm)", "Steak, sirloin, USDA Choice, bone-in, per lb. (453.6 gm)", "Steak, sirloin, graded and ungraded, excluding USDA Prime and Choice, per lb. (453.6 gm)", "Steak, sirloin, USDA Choice, boneless, per lb. (453.6 gm)", "Bacon, sliced, per lb. (453.6 gm)", "Chops, center cut, bone-in, per lb. (453.6 gm)", "Chops, boneless, per lb. (453.6 gm)", "Ham, rump or shank half, bone-in, smoked,per lb. (453.6 gm)", "Ham, boneless, excluding canned, per lb. (453.6 gm)", "Ham, rump portion, bone-in, smoked (cost per pound/453.6 grams)", "Ham, shank portion, bone-in, smoked (cost per pound/453.6 grams)", "Ham, canned, 3 or 5 lbs, per lb. (453.6 gm)", "Pork shoulder roast, blade boston, bone-in (cost per pound/453.6 grams)", "Pork sirloin roast, bone-in (cost per pound/453.6 grams)", "Shoulder picnic, bone-in, smoked, per lb. (453.6 gm)", "Sausage, fresh, loose, per lb. (453.6 gm)", "Frankfurters, all meat or all beef, per lb. (453.6 gm)", "Bologna, all beef or mixed, per lb. (453.6 gm)", "Beef liver (cost per pound/453.6 grams)", "Lamb and mutton, bone-in, per lb. (453.6 gm)", "Chicken, fresh, whole, per lb. (453.6 gm)", "Chicken breast, bone-in, per lb. (453.6 gm)", "Chicken legs, bone-in, per lb. (453.6 gm)", "Turkey, frozen, whole, per lb. (453.6 gm)", "Tuna, light, chunk, per lb. (453.6 gm)", "Eggs, grade A, large, per doz.", "Eggs, grade AA, large, per doz.", "Milk, fresh, whole, fortified, per 1/2 gal. (1.9 lit)", "Milk, fresh, whole, fortified, per gal. (3.8 lit)", "Milk, fresh, skim (cost per one-half gallon/1.9 liters)", "Milk, fresh, low fat, per 1/2 gal. (1.9 lit)", "Milk, fresh, low fat, per gal. (3.8 lit)", "Butter, salted, grade AA, stick, per lb. (453.6 gm)", "Yogurt, natural, fruit flavored, per 8 oz. (226.8 gm)", "American processed cheese, per lb. (453.6 gm)", "Cheddar cheese, natural, per lb. (453.6 gm)", "Ice cream, prepackaged, bulk, regular, per 1/2 gal. (1.9 lit)", "Apples, Red Delicious, per lb. (453.6 gm)", "Bananas, per lb. (453.6 gm)", "Oranges, Navel, per lb. (453.6 gm)", "Oranges, Valencia, per lb. (453.6 gm)", "Grapefruit, per lb. (453.6 gm)", "Lemons, per lb. (453.6 gm)", "Pears, Anjou, per lb. (453.6 gm)", "Peaches, per lb. (453.6 gm)", "Strawberries, dry pint, per 12 oz. (340.2 gm)", "Grapes, Emperor or Tokay (cost per pound/453.6 grams)", "Grapes, Thompson Seedless, per lb. (453.6 gm)", "Cherries, per lb. (453.6 gm)", "Potatoes, white (cost per pound/453.6 grams)", "Potatoes, white, per lb. (453.6 gm)", "Lettuce, iceberg, per lb. (453.6 gm)", "Tomatoes, field grown, per lb. (453.6 gm)", "Cabbage, per lb. (453.6 gm)", "Celery, per lb. (453.6 gm)", "Carrots, short trimmed and topped, per lb. (453.6 gm)", "Onions, dry yellow, per lb. (453.6 gm)", "Onions, green scallions (cost per pound/453.6 grams)", "Peppers, sweet, per lb. (453.6 gm)", "Corn on the cob, per lb. (453.6 gm)", "Radishes (cost per pound/453.6 grams)", "Cucumbers, per lb. (453.6 gm)", "Beans, green, snap (cost per pound/453.6 grams)", "Mushrooms (cost per pound/453.6 grams)", "Broccoli, per lb. (453.6 gm)", "Orange juice, frozen concentrate, 12 oz. can, per 16 oz. (473.2 ml)", "Apple Sauce, any variety, all sizes, per lb. (453.6 gm)", "Peaches, any variety, all sizes, per lb. (453.6 gm)", "Potatoes, frozen, French fried, per lb. (453.6 gm)", "Corn, canned, any style, all sizes, per lb. (453.6 gm)", "Tomatoes, canned, whole, per lb. (453.6 gm)", "Tomatoes, canned, any type, all sizes,  per lb. (453.6 gm)", "Beans, dried, any type, all sizes, per lb. (453.6 gm)", "Hard candy, solid (cost per pound/453.6 grams)", "Sugar, white, all sizes, per lb. (453.6 gm)", "Sugar, white, 33-80 oz. pkg, per lb. (453.6 gm)", "Jelly (cost per pound/453.6 grams)", "Margarine, vegetable oil blends, stick (cost per pound/453.6 grams)", "Margarine, vegetable oil blends, soft, tubs (cost per pound/453.6 grams)", "Margarine, stick, per lb. (453.6 gm)", "Margarine, soft, tubs, per lb. (453.6 gm)", "Shortening, vegetable oil blends, per lb. (453.6 gm)", "Peanut butter, creamy, all sizes, per lb. (453.6 gm)", "Cola, non-diet, return bottles, 6 or 8 pack (cost per 16 ounces/473.2 ml)", "Cola, non diet, return bottles, 24-40 ounce (cost per 16 ounces/473.2 ml)", "Cola, nondiet, cans, 72 oz. 6 pk., per 16 oz. (473.2 ml)", "Cola, nondiet, per 2 liters (67.6 oz)", "Coffee, 100%, ground roast, all sizes, per lb. (453.6 gm)", "Coffee, 100%, ground roast, 13.1-20 oz. can, per lb. (453.6 gm)", "Coffee, instant, plain, regular, 6.1-14 ounce (cost per 16 ounces/453.6 grams)", "Coffee, freeze dried, regular, all sizes (cost per 16 ounces/453.6 grams)", "Coffee, freeze dried, decaf., all sizes (cost per 16 ounces/453.6 grams)", "Coffee, instant, plain, regular, all sizes, per lb. (453.6 gm)", "Coffee, instant, plain, 9.1-14 ounce (cost per 16 ounces/453.6 grams)", "Coffee, instant, plain, 3.1-6 ounce (cost per 16 ounces/453.6 grams)", "Coffee, freeze dried, plain, 3.1-9 ounce (cost per 16 ounces/453.6 grams)", "Potato chips, per 16 oz.", "Pork and beans, canned (cost per 16 ounces/453.6 grams)", "Malt beverages, all types, all sizes, any origin, per 16 oz. (473.2 ml)", "Bourbon whiskey, 375 ml-1.75 liter (cost per 25.4 ounces/750 ml)", "Vodka, domestic, 375 ml-1.75 liter (cost per 25.4 ounces/750 ml)", "Vodka, all types, all sizes, any origin, per 1 liter (33.8 oz)", "Wine, red and white table, all sizes, any origin, per 1 liter (33.8 oz)", "Fuel oil #2 per gallon (3.785 liters)", "Utility (piped) gas - 40 therms", "Electricity per KWH", "Utility (piped) gas - 100 therms", "Utility (piped) gas per therm", "Electricity per 500 KWH", "Gasoline, leaded regular (cost per gallon/3.8 liters)", "Gasoline, leaded premium (cost per gallon/3.8 liters)", "Gasoline, unleaded regular, per gallon/3.785 liters", "Gasoline, unleaded midgrade, per gallon/3.785 liters", "Gasoline, unleaded premium, per gallon/3.785 liters", "Automotive diesel fuel, per gallon/3.785 liters", "Gasoline, all types, per gallon/3.785 liters", "All uncooked ground beef, per lb. (453.6 gm)", "All Uncooked Beef Roasts, per lb. (453.6 gm)", "All Uncooked Beef Steaks, per lb. (453.6 gm)", "All Uncooked Other Beef (Excluding Veal), per lb. (453.6 gm)", "All Ham (Excluding Canned Ham and Luncheon Slices), per lb. (453.6 gm)", "All Pork Chops, per lb. (453.6 gm)", "All Other Pork (Excluding Canned Ham and Luncheon Slices), per lb. (453.6 gm)", "Chicken breast, boneless, per lb. (453.6 gm)", "Lettuce, romaine, per lb. (453.6 gm)" ] 
},
"id": "chart280847ef32fe" 
}
  
  $scope.filters = _.map(_.unzip($scope.opts.filters),function(d){return _.zipObject(_.keys($scope.opts.filters),d)})
  
  d3.tsv("./data/ap.data.0.Current.tsv", function(err,data){
    $scope.data = data;
  })
  
  $scope.drawChart = function( data ){
    drawChart( $scope.opts, data )  
  }

  $scope.$watch('selected', function(){
    if (!(typeof($scope.selected) === "undefined")) {
      $scope.drawChart(
        _.select($scope.data, function(c){    
          return _.pluck($scope.selected,"code").indexOf(c.series_id.replace(/\w{3,4}0{3,4}(\d*)\s*/,"$1")) != -1
        })
      )
    }
  }) 
}  


//nearly all the code can be attributed to http://bl.ocks.org/3891711

function drawChart( params, data ) {
  if( typeof(params.margin) === "undefined" ) {
    params.margin = params.margin ? params.margin : {top: 20, right: 220, bottom: 30, left: 100}
  }
  var width = params.width - params.margin.left - params.margin.right,
      height = params.height - params.margin.top - params.margin.bottom;
          
  //make our svg that will house the chart
  var svg = d3.select("#"+params.id).select("svg")[0][0] ? d3.select("#"+params.id).select("svg") :  d3.select("#"+params.id).append("svg")
    .attr("width", width + params.margin.left + params.margin.right)
    .attr("height", height + params.margin.top + params.margin.bottom)
  var chart = svg.select(".chart")[0][0] ? svg.select(".chart") : svg.append("g")
    .attr("class","chart")
    .attr("transform", "translate(" + params.margin.left + "," + params.margin.top + ")");        
          
      
  var format = d3.time.format("%b %Y");
  
  data.forEach(function(d){
    d.value = +d.value;
    d.year = +d.year;
    d.date = d3.time.format("M%m %Y").parse(d.period + " " + d.year)
  });
  
  var range = d3.extent(data,function(d) { return d.date; }  )
  
  var x = d3.time.scale()
      .range([0,width])
      .domain(range);
  
  var y = d3.scale.linear()
      .range([height, 0])
      .domain([
        0,
        d3.max(data,function(d){return +d.value})
      ]);
    
          
  
  var color = function(i) {
    return d3.hcl(48*i,95,45).toString();
  };
  
  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");
  
  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left");
  
  var line = d3.svg.line()
      .interpolate("basis")
      //.defined(function(d) { return d != null; })
      .x(function(d,i) {
        return x(d.date);
      })
      .y(function(d) { 
        return y(d.value);
      });


    data = d3.nest().key(function(d){return d.series_id.replace(/\w{3,4}0{3,4}(\d*)\s*/,"$1")}).entries(data);
    

  
    var xax = (chart.select(".x.axis")[0][0] ? chart.select(".x.axis") : chart.append("g"))
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);
  
    var yax = (chart.select(".y.axis")[0][0] ? chart.select(".y.axis") : chart.append("g"))
        .attr("class", "y axis")
        .call(yAxis);
        
    if(!(yax.select("text")[0][0])) {
      yax
        .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .style("font-weight", "bold")
          .text("Average Price");
    }
    
    var series = chart.selectAll(".line").data(data)
    
    series.enter()
        .append("path")
        .attr("class", "line");
    
  /*  series.enter()
        .append("path")
        .attr("class", "invisible hover");
    */
  
    series
      .attr("d", function(d) { return line(d.values); })
      .style("stroke", function(d,i) {
        return color(i);
      });    
      
    series.exit().remove();      
      
    chart.selectAll(".invisible.hover")      
      .attr("d", function(d) { return line(d.values); });          
    

  
   /* var labels = newdata.map(function(d) { return {name: d.name, y: y(d.values[d.values.length - 1])}});
  
    series.append("text")
        .attr("class", "label hover")
        .data(labels)
        .attr("transform", function(d) { return "translate(" + x(end) + "," + d.y + ")"; })
        .attr("x", 3)
        .attr("dy", ".35em")
        .style("fill", function(d,i) { return color(i); })
        .text(function(d) { return d.name; });
  
    // constraint relaxation on labels
    var alpha = 0.5;
    var spacing = 12;
    function relax() {
      var again = false;
      labels.forEach(function(a,i) {
        labels.slice(i+1).forEach(function(b) {
          var dy = a.y - b.y;
          if (Math.abs(dy) < spacing) {
            again = true;
            var sign = dy > 0 ? 1 : -1;
            a.y += sign*alpha;
            b.y -= sign*alpha;
          }
        });
      });
      d3.selectAll(".label")
        .attr("transform", function(d) { return "translate(" + x(end) + "," + d.y + ")"; });
      if (again) setTimeout(relax,20);
    };
  
    relax();
  */
    series.selectAll(".hover")
        .on("mouseover", function(d,i) {
          d3.selectAll(".line")
            .style("opacity", 0.12)
            .filter(function(p) { return p.name == d.name; })
            .style("opacity", 1)
            .style("stroke-width", 2.5);
          d3.selectAll(".series text")
            .style("opacity", 0)
            .filter(function(p) { return p.name == d.name; })
            .style("opacity", 1);
        })
        .on("mouseout", function(d,i) {
          d3.selectAll(".line")
            .style("opacity", 1)
            .style("stroke-width", null);
          d3.selectAll(".series text")
            .style("opacity", 1);
        });
};


</script>
    
    <script></script>    
  </body>
</html>
